<!DOCTYPE html>
<html lang="zh-CN" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PACountdown - ç½‘é¡µç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen transition-colors duration-300 bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 flex items-center justify-center p-4">
    <div id="app" class="w-full max-w-md">
        <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
        <div class="absolute top-4 right-4 flex gap-2">
            <button @click="toggleLanguage" class="p-2 rounded-lg bg-white/20 dark:bg-gray-800/20 backdrop-blur-sm border border-white/30 dark:border-gray-700/30 hover:bg-white/30 dark:hover:bg-gray-800/30 transition-all duration-200">
                <span class="text-sm font-medium text-gray-800 dark:text-gray-100">{{ language === 'zh' ? 'ä¸­/En' : 'En/ä¸­' }}</span>
            </button>
            <button @click="toggleTheme" class="p-2 rounded-lg bg-white/20 dark:bg-gray-800/20 backdrop-blur-sm border border-white/30 dark:border-gray-700/30 hover:bg-white/30 dark:hover:bg-gray-800/30 transition-all duration-200">
                <svg v-if="!isDarkMode" class="w-5 h-5 text-gray-800 dark:text-gray-100" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                </svg>
                <svg v-else class="w-5 h-5 text-gray-800 dark:text-gray-100" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>

        <!-- ä¸»å®¹å™¨ -->
        <div class="bg-white/80 dark:bg-gray-800/90 backdrop-blur-xl rounded-3xl p-8 shadow-2xl border border-white/20 dark:border-gray-700/20">
            <!-- æ ‡é¢˜åŒºåŸŸ -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-light text-gray-800 dark:text-white mb-2">{{ t('title') }}</h1>
                <p class="text-gray-600 dark:text-gray-300 text-sm">{{ t('subtitle') }}</p>
            </div>
            
            <!-- çŠ¶æ€ç½‘æ ¼ -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-gray-700 dark:to-gray-600 rounded-2xl p-4 border border-blue-200/50 dark:border-gray-600/50">
                    <div class="text-xs text-blue-600 dark:text-blue-200 mb-1">{{ t('marketStatus') }}</div>
                    <div class="text-lg font-medium text-blue-800 dark:text-white">{{ marketStatus }}</div>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-gray-700 dark:to-gray-600 rounded-2xl p-4 border border-green-200/50 dark:border-gray-600/50">
                    <div class="text-xs text-green-600 dark:text-green-200 mb-1">{{ t('currentTime') }}</div>
                    <div class="text-lg font-medium text-green-800 dark:text-white">{{ currentTime }}</div>
                </div>
            </div>
            
            <!-- å€’è®¡æ—¶æ˜¾ç¤º -->
            <div class="text-center mb-8">
                <div class="text-6xl font-light text-gray-800 dark:text-white font-mono tracking-wider">{{ countdownDisplay }}</div>
            </div>
            
            <!-- æŽ§åˆ¶æŒ‰é’® -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button @click="toggleSound" class="btn-primary dark:text-white">
                    ðŸ”Š <span class="align-middle dark:text-white">{{ soundButtonText }}</span>
                </button>
                <button @click="testSound" class="btn-secondary dark:text-white">
                    ðŸŽµ <span class="align-middle dark:text-white">{{ t('testSound') }}</span>
                </button>
                <button @click="toggleMarketMode" class="btn-primary dark:text-white">
                    ðŸ“ˆ <span class="align-middle dark:text-white">{{ marketButtonText }}</span>
                </button>
                <button @click="resetTimer" class="btn-secondary dark:text-white">
                    ðŸ”„ <span class="align-middle dark:text-white">{{ t('reset') }}</span>
                </button>
            </div>
            
            <!-- é€šçŸ¥è®¾ç½® -->
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-gray-700 dark:to-gray-600 rounded-2xl p-4 border border-purple-200/50 dark:border-gray-600/50">
                <div class="text-sm text-purple-600 dark:text-purple-200 mb-3">
                    {{ t('notificationTime') }}: <span class="font-medium">{{ preNotificationSeconds }}</span> {{ t('seconds') }}
                </div>
                <div class="relative">
                    <input type="range" min="5" max="30" v-model="preNotificationSeconds" 
                           class="w-full h-2 bg-purple-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer slider dark:text-white">
                </div>
            </div>
        </div>
    </div>

    <style>
        .btn-primary {
            @apply bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white dark:text-white px-4 py-3 rounded-xl font-medium transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl;
        }
        
        .btn-secondary {
            @apply bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white dark:text-white px-4 py-3 rounded-xl font-medium transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl;
        }
        
        .slider::-webkit-slider-thumb {
            @apply appearance-none w-6 h-6 bg-purple-500 rounded-full cursor-pointer shadow-lg hover:shadow-xl transition-all duration-200;
        }
        
        .slider::-moz-range-thumb {
            @apply w-6 h-6 bg-purple-500 rounded-full cursor-pointer border-0 shadow-lg hover:shadow-xl transition-all duration-200;
        }
        
        .slider:focus {
            @apply outline-none ring-2 ring-purple-500/50;
        }
    </style>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch } = Vue;

        createApp({
            setup() {
                // å“åº”å¼æ•°æ®
                const language = ref('zh');
                const isDarkMode = ref(false);
                const timeRemaining = ref(300);
                const isTimerRunning = ref(false);
                const soundEnabled = ref(true);
                const marketModeOnly = ref(true);
                const preNotificationSeconds = ref(10);
                const audioInitialized = ref(false);
                const currentTime = ref('--:--:--');
                const marketStatus = ref('æ£€æŸ¥ä¸­...');
                
                // éŸ³é¢‘å¯¹è±¡
                let tickAudio = null;
                let finalTickAudio = null;
                let mainTimer = null;
                let clockTimer = null;
                let marketCheckTimer = null;
                let lastSecond = -1;

                // å¤šè¯­è¨€é…ç½®
                const translations = {
                    zh: {
                        title: 'PACountdown',
                        subtitle: 'ç²¾å‡†çš„5åˆ†é’Ÿé—´éš”å€’è®¡æ—¶å™¨',
                        marketStatus: 'å¸‚åœºçŠ¶æ€',
                        currentTime: 'å½“å‰æ—¶é—´',
                        marketOpen: 'å¸‚åœºå¼€æ”¾',
                        marketClosed: 'å¸‚åœºå…³é—­',
                        checking: 'æ£€æŸ¥ä¸­...',
                        soundOn: 'å£°éŸ³å¼€å¯',
                        soundOff: 'å£°éŸ³å…³é—­',
                        audioLoading: 'éŸ³é¢‘åŠ è½½ä¸­...',
                        testSound: 'æµ‹è¯•å£°éŸ³',
                        marketMode: 'ä»…äº¤æ˜“æ—¶é—´',
                        allDayMode: 'å…¨å¤©è¿è¡Œ',
                        reset: 'é‡ç½®',
                        notificationTime: 'æå‰é€šçŸ¥æ—¶é—´',
                        seconds: 'ç§’',
                        audioNotInitialized: 'éŸ³é¢‘å°šæœªåˆå§‹åŒ–ï¼Œè¯·ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®åŽå†è¯•',
                        enableSoundFirst: 'è¯·å…ˆå¼€å¯å£°éŸ³åŠŸèƒ½'
                    },
                    en: {
                        title: 'PACountdown',
                        subtitle: 'Precise 5-Minute Interval Timer',
                        marketStatus: 'Market Status',
                        currentTime: 'Current Time',
                        marketOpen: 'Market Open',
                        marketClosed: 'Market Closed',
                        checking: 'Checking...',
                        soundOn: 'Sound On',
                        soundOff: 'Sound Off',
                        audioLoading: 'Audio Loading...',
                        testSound: 'Test Sound',
                        marketMode: 'Trading Hours Only',
                        allDayMode: 'All Day',
                        reset: 'Reset',
                        notificationTime: 'Early Notification',
                        seconds: 'seconds',
                        audioNotInitialized: 'Audio not initialized, please click anywhere on the page first',
                        enableSoundFirst: 'Please enable sound first'
                    }
                };

                // è®¡ç®—å±žæ€§
                const t = (key) => translations[language.value][key] || translations.en[key] || key;
                
                const countdownDisplay = computed(() => {
                    const minutes = Math.floor(timeRemaining.value / 60);
                    const seconds = timeRemaining.value % 60;
                    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
                });

                const soundButtonText = computed(() => {
                    if (!audioInitialized.value) return t('audioLoading');
                    return soundEnabled.value ? t('soundOn') : t('soundOff');
                });

                const marketButtonText = computed(() => {
                    return marketModeOnly.value ? t('marketMode') : t('allDayMode');
                });

                // æ–¹æ³•
                const detectLanguage = () => {
                    const savedLanguage = localStorage.getItem('language');
                    if (savedLanguage && translations[savedLanguage]) {
                        language.value = savedLanguage;
                    } else {
                        const browserLang = navigator.language || navigator.userLanguage;
                        language.value = browserLang.startsWith('zh') ? 'zh' : 'en';
                    }
                };

                const toggleLanguage = () => {
                    language.value = language.value === 'zh' ? 'en' : 'zh';
                    localStorage.setItem('language', language.value);
                    document.title = t('title') + ' - ' + t('subtitle');
                };

                const toggleTheme = () => {
                    isDarkMode.value = !isDarkMode.value;
                    const html = document.documentElement;
                    if (isDarkMode.value) {
                        html.classList.remove('light');
                        html.classList.add('dark');
                    } else {
                        html.classList.remove('dark');
                        html.classList.add('light');
                    }
                    localStorage.setItem('theme', isDarkMode.value ? 'dark' : 'light');
                };

                const initTheme = () => {
                    const savedTheme = localStorage.getItem('theme');
                    if (savedTheme === 'dark' || savedTheme === 'light') {
                        isDarkMode.value = savedTheme === 'dark';
                    } else {
                        isDarkMode.value = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    }
                    toggleTheme(); // åº”ç”¨ä¸»é¢˜
                };

                const initAudio = () => {
                    tickAudio = new Audio('tick.wav');
                    finalTickAudio = new Audio('final_tick.wav');
                    
                    tickAudio.preload = 'auto';
                    finalTickAudio.preload = 'auto';
                    tickAudio.volume = 0.7;
                    finalTickAudio.volume = 0.8;

                    const initAudioOnInteraction = () => {
                        if (audioInitialized.value) return;
                        
                        try {
                            tickAudio.muted = true;
                            finalTickAudio.muted = true;
                            
                            Promise.all([
                                tickAudio.play(),
                                finalTickAudio.play()
                            ]).then(() => {
                                tickAudio.pause();
                                finalTickAudio.pause();
                                tickAudio.muted = false;
                                finalTickAudio.muted = false;
                                audioInitialized.value = true;
                                console.log('éŸ³é¢‘ä¸Šä¸‹æ–‡å·²è§£é”');
                            }).catch(e => {
                                console.log('éŸ³é¢‘è§£é”å¤±è´¥:', e);
                                audioInitialized.value = true;
                            });
                        } catch (e) {
                            console.log('éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥:', e);
                            audioInitialized.value = true;
                        }
                    };

                    const events = ['click', 'touchstart', 'keydown', 'mousedown'];
                    events.forEach(event => {
                        document.addEventListener(event, initAudioOnInteraction, { once: true });
                    });
                };

                const playTickSound = () => {
                    if (soundEnabled.value && audioInitialized.value && tickAudio) {
                        try {
                            tickAudio.currentTime = 0;
                            tickAudio.play().catch(e => {
                                console.log('TickéŸ³é¢‘æ’­æ”¾å¤±è´¥:', e);
                            });
                        } catch (e) {
                            console.log('TickéŸ³é¢‘æ’­æ”¾é”™è¯¯:', e);
                        }
                    }
                };

                const playFinalTickSound = () => {
                    if (soundEnabled.value && audioInitialized.value && finalTickAudio) {
                        try {
                            finalTickAudio.currentTime = 0;
                            finalTickAudio.play().catch(e => {
                                console.log('Final tickéŸ³é¢‘æ’­æ”¾å¤±è´¥:', e);
                            });
                        } catch (e) {
                            console.log('Final tickéŸ³é¢‘æ’­æ”¾é”™è¯¯:', e);
                        }
                    }
                };

                const toggleSound = () => {
                    soundEnabled.value = !soundEnabled.value;
                    localStorage.setItem('soundEnabled', soundEnabled.value.toString());
                };

                const testSound = () => {
                    if (!audioInitialized.value) {
                        alert(t('audioNotInitialized'));
                        return;
                    }
                    
                    if (!soundEnabled.value) {
                        alert(t('enableSoundFirst'));
                        return;
                    }
                    
                    playTickSound();
                };

                const toggleMarketMode = () => {
                    marketModeOnly.value = !marketModeOnly.value;
                    localStorage.setItem('marketModeOnly', marketModeOnly.value.toString());
                    checkMarketHours();
                };

                const resetTimer = () => {
                    stopMainTimer();
                    checkMarketHours();
                };

                const calculateAndSetInitialTime = () => {
                    const now = new Date();
                    const minute = now.getMinutes();
                    const second = now.getSeconds();
                    const secondsIntoInterval = (minute % 5) * 60 + second;
                    timeRemaining.value = Math.max(0, 300 - secondsIntoInterval);
                };

                const startMainTimer = () => {
                    if (isTimerRunning.value) return;

                    isTimerRunning.value = true;
                    calculateAndSetInitialTime();
                    lastSecond = new Date().getSeconds();

                    mainTimer = setInterval(() => {
                        const currentSecond = new Date().getSeconds();

                        if (currentSecond !== lastSecond) {
                            lastSecond = currentSecond;
                            timeRemaining.value -= 1;

                            if (timeRemaining.value < 0) {
                                calculateAndSetInitialTime();
                                return;
                            }

                            if (soundEnabled.value) {
                                if (timeRemaining.value === 0) {
                                    playFinalTickSound();
                                } else if (timeRemaining.value <= preNotificationSeconds.value && timeRemaining.value > 0) {
                                    playTickSound();
                                }
                            }

                            if (timeRemaining.value === 0) {
                                setTimeout(() => {
                                    calculateAndSetInitialTime();
                                }, 500);
                            }
                        }
                    }, 50);
                };

                const stopMainTimer = () => {
                    isTimerRunning.value = false;
                    if (mainTimer) {
                        clearInterval(mainTimer);
                        mainTimer = null;
                    }
                    lastSecond = -1;
                };

                const startClockTimer = () => {
                    updateCurrentTime();
                    clockTimer = setInterval(() => {
                        updateCurrentTime();
                    }, 1000);
                };

                const updateCurrentTime = () => {
                    const now = new Date();
                    currentTime.value = now.toLocaleTimeString('zh-CN', { hour12: false });
                };

                const isMarketOpen = () => {
                    const now = new Date();
                    const easternTime = new Date(now.toLocaleString("en-US", { timeZone: "America/New_York" }));

                    const weekday = easternTime.getDay();
                    if (weekday === 0 || weekday === 6) return false;

                    const hour = easternTime.getHours();
                    const minute = easternTime.getMinutes();
                    const currentTimeInMinutes = hour * 60 + minute;

                    const marketOpenTimeInMinutes = 9 * 60 + 30;
                    const marketCloseTimeInMinutes = 16 * 60;

                    return currentTimeInMinutes >= marketOpenTimeInMinutes && currentTimeInMinutes < marketCloseTimeInMinutes;
                };

                const checkMarketHours = () => {
                    if (isMarketOpen()) {
                        marketStatus.value = t('marketOpen');
                        startMainTimer();
                    } else {
                        marketStatus.value = t('marketClosed');
                        if (marketModeOnly.value) {
                            stopMainTimer();
                        } else {
                            startMainTimer();
                        }
                    }
                };

                const startMarketCheckTimer = () => {
                    marketCheckTimer = setInterval(() => {
                        checkMarketHours();
                    }, 60000);
                };

                const loadSettings = () => {
                    const savedSound = localStorage.getItem('soundEnabled');
                    if (savedSound !== null) {
                        soundEnabled.value = savedSound === 'true';
                    }

                    const savedMarketMode = localStorage.getItem('marketModeOnly');
                    if (savedMarketMode !== null) {
                        marketModeOnly.value = savedMarketMode === 'true';
                    }

                    const savedNotificationTime = localStorage.getItem('preNotificationSeconds');
                    if (savedNotificationTime !== null) {
                        preNotificationSeconds.value = parseInt(savedNotificationTime);
                    }
                };

                // ç›‘å¬å™¨
                watch(preNotificationSeconds, (newValue) => {
                    localStorage.setItem('preNotificationSeconds', newValue.toString());
                });

                watch(language, () => {
                    checkMarketHours(); // æ›´æ–°å¸‚åœºçŠ¶æ€æ–‡æœ¬
                });

                // ç”Ÿå‘½å‘¨æœŸ
                onMounted(() => {
                    detectLanguage();
                    loadSettings();
                    initTheme();
                    initAudio();
                    startClockTimer();
                    startMarketCheckTimer();
                    checkMarketHours();
                    document.title = t('title') + ' - ' + t('subtitle');

                    // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
                    document.addEventListener('visibilitychange', () => {
                        if (!document.hidden) {
                            resetTimer();
                        }
                    });
                });

                onUnmounted(() => {
                    if (mainTimer) clearInterval(mainTimer);
                    if (clockTimer) clearInterval(clockTimer);
                    if (marketCheckTimer) clearInterval(marketCheckTimer);
                });

                return {
                    language,
                    isDarkMode,
                    timeRemaining,
                    soundEnabled,
                    marketModeOnly,
                    preNotificationSeconds,
                    audioInitialized,
                    currentTime,
                    marketStatus,
                    t,
                    countdownDisplay,
                    soundButtonText,
                    marketButtonText,
                    toggleLanguage,
                    toggleTheme,
                    toggleSound,
                    testSound,
                    toggleMarketMode,
                    resetTimer
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
